<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Kryten Introduction</title>
    <!--<script src="../hand.js"></script> -->
	
	<script src="https://cdn.babylonjs.com/babylon.js"></script>
	<!--<script src="https://cdn.babylonjs.com/gui/babylon.gui.js"></script>-->
	<!--<script src="https://preview.babylonjs.com/babylon.js"></script>-->
	<script src="https://cdn.babylonjs.com/gui/babylon.gui.js"></script>
	<!--<script src="babylon.mixMaterial.min.js"></script> -->
    <!--<script src="../babylon.2.5.js"></script> -->
	
	<!-- <link rel="icon" href="data:,"> -->
	
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
        }
		
		#fps {
		position: absolute;
		background-color: black;
		border:2px solid red;
		text-align:center;
		font-size: 16px;
		color: white;
		top: 15px;
		left: 10px;
		width: 60px;
		height: 20px;
		display: block;
		}
		
		#DCs {
		position: absolute;
		background-color: black;
		border:2px solid red;
		text-align:center;
		font-size: 16px;
		color: white;
		top: 15px;
		left: 80px;
		width: 60px;
		height: 20px;
		display:block;
		}
		
		#meshes {
		position: absolute;
		background-color: black;
		border:2px solid red;
		text-align:center;
		font-size: 16px;
		color: white;
		top: 50px;
		left: 10px;
		width: 132px;
		height: 20px;
		display:block;
		}
		
		#verts {
		position: absolute;
		background-color: black;
		border:2px solid red;
		text-align:center;
		font-size: 16px;
		color: white;
		top: 85px;
		left: 10px;
		width: 132px;
		height: 20px;
		display:block;
		}
		
		#credits {
		position: absolute;
		text-align: center;
		font-size: 60px;
		color: red;
		top: 50%;
		width: 100%;
		height: 60px;
		display: none;
		}
		
		#container {
		width: 1000px ;
		margin-left: auto ;
		margin-right: auto ;
		}
		 
		#loader {
		position: absolute;
		background-color: red;
		width: 100%;
        height: 100%;
		text-align: center;
		font-size: 30px;
		color: white;
		display:none;
		}
		
    </style>
</head>
<body>
	<div id ="loader">Loading...</div>
	<div id = "fps">0</div>
	<div id ="DCs">0</div>
	<div id ="meshes">0</div>
	<div id = "verts">0</div>
	<div id = "credits">vvvvvvv</div>
<!--
	<div id ="container">
	<div id = "credits" >"Bassa Island" royalty free music composed by Kevin Mcleod at www.incompetech.com 
</br>Licensed under Creative Commons: By Attribution 4.0 License
http://creativecommons.org/licenses/by/4.0/
	
	
	</div> </div>
-->
	
    <canvas id="renderCanvas"></canvas>
    <script>
        if (BABYLON.Engine.isSupported()) {
            var canvas = document.getElementById("renderCanvas");
            var engine = new BABYLON.Engine(canvas, true);
			var divFps = document.getElementById("fps");
			var divDCs = document.getElementById("DCs");
			var divAllMeshs = document.getElementById("meshes");
			var divEnding = document.getElementById("credits")
			var divVerts = document.getElementById("verts")
			var myScene = new BABYLON.Scene(engine);
			//var sceneInstru;
			var myCamera;
			var myCamera1;
			var myCamera2;
			var allMeshes;
			var aCube;
			var skeleton;
			
			var soundsReady = 0;
			//var aSignal2;
			var talkNum = 0;
			var speakRange;
			var isUnlocked = 0;
			var isPlaying = 0;
			var soundArray = [
			  [0.0, 4.000],
			  [4.26, 2.57],
			  [7.03, 8.06],
			  [15.25, 5.04]
			];
			var arrayValue =0;
			var theTrack = 0;
			var trigger = 0;
			
			var speakRange;
			var walkRange;
			var whichAnim;
			var button1;
			
			var camera;
		/*	
			
			var mix = new BABYLON.MixMaterial("mix", myScene);
			
			mix.mixTexture1 = new BABYLON.Texture("terrain_map.png", myScene);
			
			mix.diffuseTexture1 = new BABYLON.Texture("set_grass_rock02.jpg", myScene);//red
			mix.diffuseTexture2 = new BABYLON.Texture("path04a.jpg", myScene);//green
			mix.diffuseTexture3 = new BABYLON.Texture("set_grass_rock01.jpg", myScene);//blue;
			mix.diffuseTexture4 = new BABYLON.Texture("new_cliff02.jpg", myScene);// alpha
			//set repeat scales
			mix.diffuseTexture1.uScale = mix.diffuseTexture1.vScale = 5;
			mix.diffuseTexture2.uScale = mix.diffuseTexture2.vScale = 5;
			mix.diffuseTexture3.uScale = mix.diffuseTexture3.vScale = 10;
			mix.diffuseTexture4.uScale = mix.diffuseTexture4.vScale = 20;
			
		*/	
			
			var dummyCamera = new BABYLON.FreeCamera("dummy",new BABYLON.Vector3(0,10,-100),myScene);
			
			
			
					
			
			var sceneInstru = new BABYLON.SceneInstrumentation(myScene);
			
			//var aLength = 4*Math.PI/8;
			var turnAngle1 = Math.PI/2;
			var turnAngle2 = 3*Math.PI/2;
			
			//draw lines to form a square left
			const points = [];
			
			points.push(new BABYLON.Vector3(0, 0, 0));
			points.push(new BABYLON.Vector3(0, 0, -2.5));
			points.push(new BABYLON.Vector3(-7, 0, -2.5));
			points.push(new BABYLON.Vector3(-7, 0, 2.5));
			points.push(new BABYLON.Vector3(0, 0, 2.5));
			//points.push(points[0]); //close the square;
			points.push(new BABYLON.Vector3(0, 0, 0));
			points.push(new BABYLON.Vector3(0, 0, -2.5));
			points.push(new BABYLON.Vector3(7, 0, -2.5));
			points.push(new BABYLON.Vector3(7, 0, 2.5));
			points.push(new BABYLON.Vector3(0, 0, 2.5));
			points.push(points[0]); //close the square;
	
		
			//BABYLON.MeshBuilder.CreateLines("squareL&R", {points: points}); // adds a mesh but is not needed
			
			
		/*	
			//draw lines to form a square right
			const points2 = [];
			points2.push(new BABYLON.Vector3(0, 0, 0));
			points2.push(new BABYLON.Vector3(0, 0, -4));
			points2.push(new BABYLON.Vector3(8, 0, -4));
			points2.push(new BABYLON.Vector3(8, 0, 4));
			points2.push(new BABYLON.Vector3(0, 0, 4));
			points2.push(points[0]); //close the square;
		
			BABYLON.MeshBuilder.CreateLines("squareR", {points: points2})
		*/	
			const slide = function (turn, dist) { //after covering dist apply turn
				this.turn = turn;
				this.dist = dist;
			}
			
			const track = [];
			track.push(new slide(turnAngle1, 2.5));
			track.push(new slide(turnAngle1, 9.5));
			track.push(new slide(turnAngle1, 14.5));
			track.push(new slide(turnAngle1, 21.5));
			track.push(new slide(turnAngle1, 24));
		/*	
			track.push(new slide(turnAngle2, 44));
			track.push(new slide(turnAngle2, 52));
			track.push(new slide(turnAngle2, 60));
			track.push(new slide(turnAngle2, 64));
			//track.push(new slide(turnAngle2, 72));
		*/	
		/*
			let distance = 0;
			let step = 0.015;
			let p = 0;
		*/
			const track2 = [];
			track2.push(new slide(turnAngle2, 2.5));
			track2.push(new slide(turnAngle2, 9.5));
			track2.push(new slide(turnAngle2, 14.5));
			track2.push(new slide(turnAngle2, 21.5));
			track2.push(new slide(turnAngle2, 24));
			
			/* original data for both tracks - just change the turnAngle
			track2.push(new slide(turnAngle2, 4));
			track2.push(new slide(turnAngle2, 12));
			track2.push(new slide(turnAngle2, 20));
			track2.push(new slide(turnAngle2, 28));
			track2.push(new slide(turnAngle2, 32));
			
			*/
				
		
			let distance = 0;
			let step = 0.015;
			let p = 0;
			trigger = 1;

		
		
			
			  //BABYLON.SceneLoader.Append("", "aCamera.babylon", myScene);
			  BABYLON.SceneLoader.Append("", "walls02.babylon", myScene);
			  BABYLON.SceneLoader.Append("", "kryten01.babylon", myScene);
			  myScene.executeWhenReady(function () {
		   
					//myScene.stopAllAnimations();
					
					var character = myScene.getMeshByName("Empty");
					var fTarget = myScene.getMeshByName("follow_cube");
					fTarget.parent = character;
					
					camera = new BABYLON.FreeCamera("camera1", new BABYLON.Vector3(0, 1.5, -4), myScene);
					camera.parent = fTarget;
					camera.fov = BABYLON.Tools.ToRadians(20);
					
					var aLight = myScene.getLightByName("Light01");
					aLight.intensity = 0.2;
				
					// set up a follow camera
					//var camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0, 0, 0), myScene);
					
					camera.fov = BABYLON.Tools.ToRadians(15);
					
					//set the glow
			/*
					var gl = new BABYLON.GlowLayer("glow", myScene, {
						mainTextureSamples: 4
					});
					//include glow for just the light mesh
					var theLights = myScene.getMeshByName("wall_lights");
					gl.addIncludedOnlyMesh(theLights);
					// set glow intensity	
					gl.intensity = 1.0;
			*/		
					//end set the glow
					
			
					
					// Attach start camera to canvas inputs
					myCamera1 = myScene.getCameraByName("Camera");
					myCamera1.wheelPrecision =100;
					myCamera1.maxZ =100;
					myCamera1.speed =0.1;
					myCamera1.fov = BABYLON.Tools.ToRadians(35);
				
					myCamera1.lowerRadiusLimit = 6;
					myCamera1.upperRadiusLimit = 10;
					myCamera1.lowerBetaLimit = 1.4000;
					myCamera1.upperBetaLimit = 1.4000;
					//myCamera1.lowerAlphaLimit = -2.071;
					//myCamera1.upperAlphaLimit = -1.0710;
					
					myCamera = myCamera1;
					myScene.activeCamera = myCamera1;
				    //myScene.activeCamera.attachControl(canvas);
					
					
					
					
					
			
		/*			temp list mesh names code
					var allMeshes = myScene.meshes;
					for (i =0; i < allMeshes.length; i++){
						console.log(allMeshes[i].name);
					}
		*/			
					myScene.clearColor = new BABYLON.Color3(0.0,0.0,0.0);
					
					//var lightMesh = myScene.getMeshByName("wall_lights");
					
					//var hl1 = new BABYLON.HighlightLayer("hl1", myScene);
					//hl1.addMesh(lightMesh, BABYLON.Color3.Blue(), true);
					//hl1.blurVerticalSize = 4;
					//hl1.blurHorizontalSize = 4;
					
					//get the empty and skeleton for the animation
					aCube = myScene.getMeshByName("Empty");
					skeleton = myScene.getSkeletonByName("kryten_rig");
					//var isFrom = skeleton
					//myScene.beginAnimation(skeleton, 1, 24, true, 0.5);
					//var thebones = skeleton.bones;
					//console.log(thebones.length);
					
					//get animation ranges
					speakRange = skeleton.getAnimationRange("aSpeakAction");
					walkRange = skeleton.getAnimationRange("aWalkAction");
					console.log(speakRange);
					
					// restart animations from keyboard with "s"
			/*		myScene.onKeyboardObservable.add((kbInfo) => {
						switch (kbInfo.type) {
							case BABYLON.KeyboardEventTypes.KEYDOWN:
								switch (kbInfo.event.key) {
									case "s":
										if(trigger === 1){
											
											trigger = 2;
											whichAnim = myScene.beginAnimation(skeleton, speakRange.from, speakRange.to, true, 1);
											kryten.play();
											button1.isVisible = false;
											
														//whichAnim.onAnimationEnd = function () {
															//alert('animatable.onAnimationEnd func reports the animation stopped');
															//trigger = 0;
															//myScene.activeCamera = camera;
															//myScene.beginAnimation(skeleton, walkRange.from, walkRange.to, true, 1);
															//console.log(trigger);
														//};
													
										}
						
										break;
									case "default":	
										break;
									}
							break;			
						}
					});
			*/		
					
					//if(trigger ===0 run it
					myScene.onBeforeRenderObservable.add(() => {
					
						if(trigger === 0){
						//lager.play();
						
						aCube.movePOV(0, 0, step);
						distance += step;
						
						if(theTrack === 0){
						
							if (distance > track[p].dist) { 
							
								aCube.rotate(BABYLON.Axis.Y, track[p].turn, BABYLON.Space.LOCAL);
								p +=1;
								p %= track.length;
									if (p === 0) {
										//console.log(p);
										theTrack = 1;
										distance = 0;
										
										aCube.position = new BABYLON.Vector3(0, 0, 0); //reset to initial conditions
										aCube.rotation = BABYLON.Vector3.Zero();//prevents error accumulation
										myScene.stopAllAnimations();
										myScene.activeCamera = myCamera1;
										//myScene.activeCamera.attachControl(canvas);
										boots.stop();
										button1.isVisible = true;
										
										trigger = 1;
										p = 0;
										
										
										
										myScene.beginAnimation(skeleton, 58, 60, false, 0.5);
									}
							} //end if
						} //end theTrack = 0
						
						else {
							if (distance > track2[p].dist) {
								aCube.rotate(BABYLON.Axis.Y, track2[p].turn, BABYLON.Space.LOCAL);
								p +=1;
								p %= track2.length;
									if (p === 0) {
										//console.log(p);
										theTrack = 0;
										distance = 0;
										aCube.position = new BABYLON.Vector3(0, 0, 0); //reset to initial conditions
										aCube.rotation = BABYLON.Vector3.Zero();//prevents error accumulation
										
										myScene.activeCamera = myCamera1;
										//myScene.activeCamera.attachControl(canvas);
										trigger = 1;
										myScene.stopAllAnimations();
										boots.stop();
										button1.isVisible = true;
										myScene.beginAnimation(skeleton, 58, 60, false, 0.5);
										//button1.isVisible = true;
									}
							}
							
						}//end else Track = 1
					
						};
						
						//lager.play();
					}); //end before render
					
					
					//}; //end trigger
					
					
					createButtons();
					createSound();
									
					
					//get total meshes and vertices
					var vertTotal = 0;
					allMeshes = myScene.meshes;
					divAllMeshs.innerHTML = allMeshes.length + " Total meshes";
					for (var i=0; i<allMeshes.length; i++){
						if (allMeshes[i].getTotalVertices() > 0){
							vertTotal = vertTotal + allMeshes[i].getTotalVertices()
						}
					}
					divVerts.innerHTML = vertTotal + " Total vertices";
				
					
				});
			};
					
					
				// Once the scene is loaded, just register a render loop to render it
				engine.runRenderLoop(function() {
					divFps.innerHTML = engine.getFps().toFixed() + " fps";
					divDCs.innerHTML = sceneInstru.drawCallsCounter.current.toString() + " DCs";
					myScene.render();
				});
    
		
		
		// Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
		
		 
		
		function createButtons(){
			console.log("create buttons");
			
			var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
					var UiPanel = new BABYLON.GUI.StackPanel();
					advancedTexture.addControl(UiPanel);

					button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Play");
					button1.width = "150px"
					button1.height = "40px";
					button1.top = "-50px";
					button1.left = "0px";
					button1.color = "yellow";
					button1.cornerRadius = 20;
					button1.background = "green";
					//button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
					button1.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
					button1.onPointerUpObservable.add(function() {
						if(isUnlocked === 0){
						   isUnlocked =1;
						   console.log("unlocked = " + isUnlocked);
						   BABYLON.Engine.audioEngine.unlock(); 
					   	}
						if (isPlaying === 0){
						if(trigger === 1){
							//kryten.play();
							//console.log(soundArray[0][1]);
							//kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
							
							trigger = 2;
							whichAnim = myScene.beginAnimation(skeleton, 0, 60, true, 1);
							kryten.play();
								//myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
							isPlaying = 1;
							button1.isVisible = false;
							
					/*		switch(arrayValue) {
							  case 0:
								// code block
								console.log(soundArray[arrayValue][1]);
								kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
								myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
								break;
							  
							  case 1:
								console.log(soundArray[arrayValue][1]);
								kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
								myScene.beginAnimation(skeleton[0], speakRange.to, speakRange.from, true);
								break;
								
								case 2:
								console.log(soundArray[arrayValue][1]);
								kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
								myScene.beginAnimation(skeleton[0], speakRange.to, speakRange.from, true);
								break;
								
								case 3:
								// code block
								console.log(soundArray[arrayValue][1]);
								kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
								myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
								break;
								
								case 4:
								// code block
								console.log(soundArray[arrayValue][1]);
								kryten.play(0, soundArray[arrayValue][0],soundArray[arrayValue][1]);
								myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
								break;
								
							  default:
								// code block
							} 
							
							
							
							arrayValue = arrayValue + 1;
							if (arrayValue >3){ 
								//{button2.isVisible = true};
								button1.isVisible = false;
								button2.isVisible = true;
								};
						}
				*/		
					}}
					});
					advancedTexture.addControl(button1);  
					
					const button2 = BABYLON.GUI.Button.CreateSimpleButton("but2", "Play Second");
					button2.width = "150px"
					button2.height = "40px";
					button2.top = "-50px";
					button2.left = "0px";
					button2.color = "yellow";
					button2.cornerRadius = 20;
					button2.background = "green";
					//button1.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
					button2.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
					button2.isVisible = false;
					button2.onPointerUpObservable.add(function() {
					
						console.log("button 2 pressed");
						
						if(isUnlocked === 0){
						   isUnlocked =1;
						   console.log("unlocked = " + isUnlocked);
						   BABYLON.Engine.audioEngine.unlock(); 
					   	}
						if (isPlaying === 0){
							lager.play();
							myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
							isPlaying = 1;
						}
					});
					advancedTexture.addControl(button2);  
				
					// end ui creation and play functionality
		};
		
		
		
		function createSound(){
		/*
			var talkArray  = [
				[0.00,10.40],[11.00,14.29],[25.50,33.50],
			];
		*/	
			kryten = new BABYLON.Sound("kryten", "psychic02.mp3", myScene, soundReady, { loop: false, volume: 0.75 });
			lager = new BABYLON.Sound("lager", "dutch_lager02.mp3", myScene, soundReady, { loop: false, volume: 0.75 });
			boots = new BABYLON.Sound("lager", "boots01d.mp3", myScene, soundReady, { loop: true, volume: 0.75 });
	
		};
	
		function soundReady() {
			soundsReady++;
			
			if(soundsReady === 3){
				console.log("sound ready");
				//myScene.beginAnimation(skeleton[0], speakRange.from, speakRange.to, true);
				//Obrien.play(0,0,10.4);
				
				//kryten.play();
				
				kryten.onended = function() {
				
					myScene.stopAllAnimations();
					//myScene.beginAnimation(skeleton[0], 52, 60, false, 0.5);
					myScene.activeCamera = camera;
					trigger = 0;
					myScene.beginAnimation(skeleton, walkRange.from, walkRange.to, true, 1);
					boots.play();
					//lager.play();
					
					console.log("sound off");
					isPlaying = 0;
					//button1.isVisible = true;
				
				/*
				//console.log(talkNum);
					switch (talkNum){
					
						case 0 :
							myScene.beginAnimation(skeleton[0], 21, 5, false);
							talkNum = 1;
							Obrien.play(0,25.5,8.0);
						break;
						
						case 1 :
							myScene.beginAnimation(skeleton[0], 5, 21, false);
							talkNum = 2;
							Obrien.play(0,11.0,14.29);
						break;
						
						case 2 :
							myScene.beginAnimation(skeleton[0], 21, 0, false);
							aButton.setEnabled(true);
							talkNum = 0;
						break;
					
					};
					
				*/	
				};
				
				lager.onended = function() {
				
					myScene.stopAllAnimations();
					myScene.beginAnimation(skeleton[0], 52, 60, false, 0.5);
					
					console.log("sound off");
					isPlaying = 0;
				};
				
			};
		
		};
	
		
		
    </script>
</body>
</html>
