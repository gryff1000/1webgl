<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>The Little Train of Wales</title>
    <!--<script src="../hand.js"></script> -->
	
	<script src="https://cdn.babylonjs.com/babylon.js"></script>
	<!--<script src="https://preview.babylonjs.com/babylon.js"></script>-->
	<script src="babylon.mixMaterial.min.js"></script>
    <!--<script src="../babylon.2.5.js"></script> -->
	
	<link rel="icon" href="data:,">
	
    <style>
        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            overflow: hidden;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
        }
		
		#fps {
		position: absolute;
		background-color: black;
		border:2px solid red;
		text-align:center;
		font-size: 16px;
		color: white;
		top: 15px;
		left: 10px;
		width: 60px;
		height:30px
		display:none;
		}
		
		#credits {
		position: absolute;
		text-align: center;
		font-size: 60px;
		color: red;
		top: 50%;
		width: 100%;
		height: 60px;
		display: none;
		}
		
		#container {
		width: 1000px ;
		margin-left: auto ;
		margin-right: auto ;
		}
		 
		#loader {
		position: absolute;
		background-color: red;
		width: 100%;
        height: 100%;
		text-align: center;
		font-size: 30px;
		color: white;
		display:none;
		}
		
    </style>
</head>
<body>
	<div id ="loader">Loading...</div>
	<div id = "fps">0</div>
	<div id = "credits">vvvvvvv</div>
<!--
	<div id ="container">
	<div id = "credits" >"Bassa Island" royalty free music composed by Kevin Mcleod at www.incompetech.com 
</br>Licensed under Creative Commons: By Attribution 4.0 License
http://creativecommons.org/licenses/by/4.0/
	
	
	</div> </div>
-->
	
    <canvas id="renderCanvas"></canvas>
    <script>
        if (BABYLON.Engine.isSupported()) {
            var canvas = document.getElementById("renderCanvas");
            var engine = new BABYLON.Engine(canvas, true);
			var divFps = document.getElementById("fps");
			//var x = document.getElementById("myDIV");
			var divEnding = document.getElementById("credits")
			var myScene = new BABYLON.Scene(engine);
			var myCamera;
			var myCamera1;
			var myCamera2;
			var camSensor;
			//var allCamera;
			var drown;
			var camFlag = 1;
			var direct = [0,1,1,1,0,0,0,1,1,0,0,1,1,1,0,0,0,1,1,0,0,0,1,1,0];
			var opened = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0,0,0,0,0,0,0,0,0,0,0];
			
			var mix = new BABYLON.MixMaterial("mix", myScene);
			
			mix.mixTexture1 = new BABYLON.Texture("terrain_map3x1.png", myScene);
			mix.diffuseTexture1 = new BABYLON.Texture("set_grass_rock01.jpg", myScene);//red;
			//mix.diffuseTexture1 = new BABYLON.Texture("grass1a.set_grass_rock01jpg", myScene)
			//mix.diffuseTexture1 = new BABYLON.Texture("grass_rock08.png", myScene)
			mix.diffuseTexture2 = new BABYLON.Texture("set_grass_rock02.jpg", myScene);//green
			//mix.diffuseTexture2 = new BABYLON.Texture("bakedRock01.jpg", myScene);//green
			//mix.diffuseTexture3 = new BABYLON.Texture("dark_gravel01.jpg", myScene);//blue
			mix.diffuseTexture3 = new BABYLON.Texture("path04a.jpg", myScene);//blue
			//mix.diffuseTexture3 = new BABYLON.Texture("bakedRock01.jpg", myScene);//blue
			mix.diffuseTexture4 = new BABYLON.Texture("new_cliff02.jpg", myScene);// alpha
			//mix.diffuseTexture4 = new BABYLON.Texture("rock2baked.png", myScene);// alpha
			//mix.diffuseTexture4 = new BABYLON.Texture("SoilSand0018x512.jpg", myScene);// alpha
			
			mix.diffuseTexture1.uScale = mix.diffuseTexture1.vScale = 20;
			//mix.diffuseTexture1.vScale = 40;
			mix.diffuseTexture2.uScale = mix.diffuseTexture2.vScale = 30;
			//mix.diffuseTexture2.vScale = 20;
			mix.diffuseTexture3.uScale = mix.diffuseTexture3.vScale = 15;
			mix.diffuseTexture4.uScale = mix.diffuseTexture4.vScale = 20;
			
			var dummyCamera = new BABYLON.FreeCamera("dummy",new BABYLON.Vector3(0,10,-100),myScene)
           
		   BABYLON.SceneLoader.Append("", "towers01.babylon", myScene);
            myScene.executeWhenReady(function () {
					
					// Attach start camera to canvas inputs
					myCamera1 = myScene.getCameraByName("Camera");
					myCamera1.wheelPrecision =5;
					myCamera1.maxZ =2200;
					myCamera1.speed =0.1;
					myCamera1.lowerRadiusLimit = 50;
					myCamera1.upperRadiusLimit = 320;
					myCamera1.lowerBetaLimit = 0.9;
					myCamera1.upperBetaLimit = 1.518;
					
					// inside castle camera
					myCamera2 = myScene.getCameraByName("Camera2");
					myCamera2.speed =0.2;
					myCamera2.maxZ =2000;
					
					//On battlements camera - to walk around
					myCamera3 = myScene.getCameraByName("Camera3");
					myCamera3.speed =0.1;
					myCamera3.maxZ =2000;
					
					// start scene with arc rotate camera
					myCamera = myCamera1;
					myScene.activeCamera = myCamera;
				    myScene.activeCamera.attachControl(canvas);
					
					/*
					camSensor = new BABYLON.Mesh.CreateBox("sensor", 1, myScene);
					camSensor.scaling = new BABYLON.Vector3(1, .1, 1);
					camSensor.position = new BABYLON.Vector3(0.0, 0.5, 0.0);
					camSensor.checkCollisions = true;
					camSensor.isPickable = false;
					camSensor.parent = myCamera2;
					myCamera2.minZ = .05;
					*/
					
					// apply textures to terrain
					var ground = myScene.getMeshByName("Landscape1a");
					ground.material = mix;
					
					// Apply sky texture - normals facing in
					var skymat = myScene.getMaterialByName("sky");
					skymat.backFaceCulling = true;
					
					// set scene parameters including scene color and fog parameters
					myScene.clearColor = new BABYLON.Color3(0.0,0.0,0.0);
					myScene.fogDensity = .0015;
					myScene.fogColor = new BABYLON.Color3(.5509,0.5509,0.509);
					
					//animate sea texture
					var theSea = myScene.getMeshByName("sea");
					BABYLON.Animation.CreateAndStartAnimation("u", theSea.material.diffuseTexture, "vOffset", 3, 1440, 0, 1, 1)
					
					camSensor = myScene.getMeshByName("camSensor1");
					drown = myScene.getMeshByName("deepSea");
					camSensor.actionManager = new BABYLON.ActionManager(myScene);
					
					camSensor.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
							{trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: drown},
							function() {
							//cube1.scaling = new BABYLON.Vector3(1.2, 1.2, 1.2);
							//iscollide = true
							myScene.fogDensity = 0.00000;
							camFlag = 4;
							divEnding.style.display = "block";
							divEnding.innerHTML = "You Drowned!!";
							//console.log("drowned");
						}
					));
					
					/*
					camSensor.actionManager = new BABYLON.ActionManager(myScene);
					
					
					let inAction = new BABYLON.ExecuteCodeAction(
							
						{trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: {mesh: drown}},
						(evt) => {
							console.log("entered sea");
							myScene.fogDensity = 0.00000;
								//theSounds.play(0, 34.5, 2.7);
								}
					);
					*/
					
					
					//camSensor.actionManager.registerAction(inAction);
					
					/* remove maybe?
					const animDoor1 = new BABYLON.Animation("openDoor", "rotation.y", 30, 
					BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
					
					const doorKeys1 = []; 
					//At the animation key 0, the value of rotation.y is 0
					doorKeys1.push({
						frame: 0,
						value: Math.PI
					});
					//At the animation key 30, (after 1 sec since animation fps = 30) the value of rotation.y is 2PI for a complete rotation
					doorKeys1.push({
						frame: 30,
						value: Math.PI * 3/2 
					});
					
					animDoor1.setKeys(doorKeys1);
					*/
					
					// change camera code with KB
					myScene.onKeyboardObservable.add((kbInfo) => {
						switch (kbInfo.type) {
							case BABYLON.KeyboardEventTypes.KEYDOWN:
								switch (kbInfo.event.key) {
									case "c":
										//console.log(kbInfo.event.key);
										
										if(camFlag === 1){
											myCamera.detachControl(canvas);
											//camSensor.parent = null;
											myScene.activeCamera = myCamera2;
											myScene.activeCamera.attachControl(canvas);
											camFlag = 2;
										}
										else if(camFlag === 2){
											myCamera.detachControl(canvas);
											//console.log(myCamera3.position);
											//camSensor.position = myCamera3.position;
											//console.log(camSensor.position);
											//camSensor.parent = myCamera3;
											myScene.activeCamera = myCamera3;
											myScene.activeCamera.attachControl(canvas);
											
											camFlag = 3;
										}
										else if(camFlag ===3){
											myCamera.detachControl(canvas);
											myScene.activeCamera = myCamera1;
											myScene.activeCamera.attachControl(canvas);
											camFlag = 1;
										}	
										break;
									}
							break;			
						}
					});
					
					
					// door click code
					myScene.onPointerObservable.add((pointerInfo) => {
					
						myScene.onPointerDown = function (evt, pickResult) {
							// We try to pick an object
							if (pickResult.hit) {
								myTrigger = pickResult.pickedMesh.name;
								//console.log(myTrigger);
								var num = parseInt(myTrigger.substr(6, 2));
								//console.log(num);
								var whichOne = "Empty" + num;
								//console.log(whichOne);
								var whichDoor = myScene.getMeshByName(whichOne);
								
								//console.log(direct[num]);
								//console.log("Rot = " + whichDoor.rotation.y);
								//
								if(opened[num] === 0){
									if(direct[num] === 1){
										whichDoor.rotation.y = whichDoor.rotation.y + Math.PI/2;
										//rotationQuaternion = null;
										//myScene.beginAnimation(whichDoor, 0, 30, false);
										//console.log(whichDoor.rotation.y);
									}
									else {
										whichDoor.rotation.y = whichDoor.rotation.y - Math.PI/2;
										//console.log(whichDoor.rotation.y);
									}
									opened[num] = 1;
								}
								else {
								
									if(direct[num] === 1){
										whichDoor.rotation.y = whichDoor.rotation.y - Math.PI/2;
										//console.log(whichDoor.rotation.y);
									}
									else {
										whichDoor.rotation.y = whichDoor.rotation.y + Math.PI/2;
									}
									opened[num] = 0;
								
								}
								
							}
						}
					});
					
					
				});
			};
					
					
				// Once the scene is loaded, just register a render loop to render it
				engine.runRenderLoop(function() {
					divFps.innerHTML = engine.getFps().toFixed() + " fps";
					//if(camFlag === 1) {console.log(myCamera1.upperBetaLimit);}
					//console.log(myCamera.radius);
					myScene.render();
				});
    
		
		
		// Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
		
		 
		
	

	
		
		
    </script>
</body>
</html>
